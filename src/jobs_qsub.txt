#!/usr/bin/env bash
#PBS -l select=1:ncpus=40:ngpus=2:gpu_model=v100:mem=372gb
#PBS -l walltime=8:00:00
#PBS -N data_compression_estimation
#PBS -M robertu@g.clemson.edu,dkrasow@g.clemson.edu 
#PBS -m abe
#PBS -j oe

#load spack
compress

#cd /path/to/compression_env
#spack env activate

function echo_do(){
  echo $@
  "$@"
}

declare -A dset_size
dset_size["SDRBENCH-Miranda-256x384x384"]="-d 256 -d 384 -d 384"
dset_size["FULL_HURRICANE"]="-d 500 -d 500 -d 100"

declare -A dset_dtype
dset_dtype["SDRBENCH-Miranda-256x384x384"]=float64
dset_dtype["FULL_HURRICANE"]=float32

for dataset in "SDRBENCH-Miranda-256x384x384" "FULL_HURRICANE"
do
for blocks in 16 32 64 128
do
  #choosing zfp, sz3d, 2x zfp, lcm(zfp,sz)/sz x2, zfp x 4, sz x 4, large
  for block_size in 4 6 8 12 16 24 32
  do

  echo_do mpiexec -np 40 ./compress_analysis -t ${dset_dtype[${dataset}]} \
    -i ${dataset} -r $COMPRESS_HOME/datasets ${dset_size[${dataset}]} \
    -o "${dataset}_blocks${blocks}_block_size${block_size}.csv" --blocks $blocks --block_size $block_size
  done
done
done
